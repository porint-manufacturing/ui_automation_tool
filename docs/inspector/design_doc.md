# UI Inspector アプリ - 設計書

## 1. 概要

Windows デスクトップアプリケーションを作成し、ユーザーが画面上の任意の UI 要素を選択して、その Automation 属性（AutomationId、Name、ControlType など）を取得・表示できるようにします。

## 2. 要件

- **画面選択モード**: ユーザーが要素をホバー/クリックして選択できるモード。
- **属性抽出**: `AutomationId`、`Name`、`ClassName`、`ControlType` などを取得。
- **出力**: コンソール（標準出力）に属性を表示。
- **インタラクション**: クリックしてキャプチャ。

## 3. 技術アーキテクチャ

### 3.1. ライブラリ

`pyautogui` は画像認識や入力シミュレーションが主であり、Windows UI Automation (UIA) API ツリーへのアクセス権限がありません。
`AutomationId` や `Name` を取得するという要件を満たすため、Windows UIA とインターフェースできるライブラリを使用する必要があります。

**提案スタック:**

- **`uiautomation` (by yinkaisheng)** または **`pywinauto`**: カーソル下の UI 要素とそのプロパティにアクセスするために使用します。`uiautomation` は直接的な UIA アクセスにおいて高速で堅牢です。
- **`pynput`**: アプリがフォーカスされていない状態でもクリックイベントを検出するためのグローバルマウスフックに使用します。
- **`pyautogui`** (オプション): ハイライト/描画が必要な場合に使用できますが、`uiautomation` にもハイライト機能が組み込まれています。

### 3.2. ワークフロー

1.  **起動**: アプリが初期化され、手順を表示します。
2.  **選択モード**:
    - アプリがグローバルマウスリスナーをインストールします。
    - (オプション) カーソル下の要素をリアルタイムでハイライト。
3.  **トリガー**:
    - ユーザーが要素上にマウスを移動します。
    - ユーザーがクリックします（例：左クリック、または通常のクリックを妨げないための Ctrl+Click などのホットキー）。
4.  **キャプチャ & 検査**:
    - クリック時にカーソル位置 `(x, y)` を取得します。
    - `uiautomation.ControlFromPoint(x, y)` を使用して要素を取得します。
    - プロパティを抽出します: `AutomationId`、`Name`、`ControlTypeName`、`ClassName`、`BoundingRectangle`。
5.  **出力**: 整形された JSON またはテキストをコンソールに出力します。
6.  **ループ/終了**: 特定の終了キー（例：Esc）が押されるまでリスニングを継続します。

## 4. 詳細コンポーネント設計

### 4.1. `Inspector` クラス

- **メソッド**:
  - `start_listening()`: `pynput` リスナーをセットアップします。
  - `on_click(x, y, button, pressed)`: マウスイベントのコールバック。
  - `inspect_element(x, y)`: UIA 要素を取得するコアロジック。
  - `display_info(control)`: データを整形して表示します。

### 4.2. 安全性と UX

- **ノンブロッキング**: リスナーは別スレッドで実行されます。
- **終了戦略**: アプリを終了するためのキーボードリスナー（'Esc'）。
- **干渉**: 純粋な左クリックキャプチャは、実際のボタンクリックをトリガーしてしまう可能性があります。
  - _推奨_: ホットキー（例：`F2` または `Ctrl` キー）を使用してカーソル下の要素を「フリーズ」してキャプチャするか、可能であればクリックイベントを抑制します（ただし抑制はリスク/複雑さが伴います）。
  - _代替案_: 「ホバーして待機」または「ホットキーでキャプチャ」。
  - _ユーザー要望_: 「マウスクリック」。クリック検知を実装しますが、副作用（実際のボタンがクリックされる）の可能性について助言します。

## 5. 提案実装手順

1.  環境セットアップ（`uiautomation`、`pynput` のインストール）。
2.  `ControlFromPoint` を使用した `Inspector` クラスの実装。
3.  `pynput` マウスリスナーの追加。
4.  `pynput` キーボードリスナーの追加（終了用）。
5.  出力フォーマットの調整。
